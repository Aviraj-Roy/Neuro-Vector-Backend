# Phase-2 Architecture Diagram

## ğŸ“Š Processing Pipeline (Visual)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PHASE-1 OUTPUT                              â”‚
â”‚              (Exhaustive Item-Level Listing)                        â”‚
â”‚                                                                     â”‚
â”‚  â€¢ Every item listed (including duplicates)                         â”‚
â”‚  â€¢ Hybrid semantic matching applied                                 â”‚
â”‚  â€¢ Basic status: GREEN, RED, MISMATCH                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STEP 1: RATE CACHE BUILDER                       â”‚
â”‚                           [ğŸ’¾ Cache]                                â”‚
â”‚                                                                     â”‚
â”‚  Input:  Phase-1 line items                                         â”‚
â”‚  Output: rate_cache = {                                             â”‚
â”‚            ("nicorandil_5mg", "NICORANDIL 5MG"): 49.25,            â”‚
â”‚            ("paracetamol_500mg", "PARACETAMOL 500MG"): 15.00       â”‚
â”‚          }                                                          â”‚
â”‚                                                                     â”‚
â”‚  Purpose: Cache allowed rates to avoid redundant lookups            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     STEP 2: ITEM AGGREGATOR                         â”‚
â”‚                        [ğŸ“¦ Group Items]                             â”‚
â”‚                                                                     â”‚
â”‚  Group By: (normalized_name, matched_reference, category)           â”‚
â”‚                                                                     â”‚
â”‚  Example:                                                           â”‚
â”‚    NICORANDIL 5MG (x4 occurrences)                                  â”‚
â”‚      Total Bill: â‚¹78.80                                             â”‚
â”‚      Allowed (per unit): â‚¹49.25                                     â”‚
â”‚      Applied Allowed: â‚¹49.25 Ã— 4 = â‚¹197.00                          â”‚
â”‚      Breakdown:                                                     â”‚
â”‚        - LineItemID: item_001 | Bill: â‚¹19.70                        â”‚
â”‚        - LineItemID: item_002 | Bill: â‚¹19.70                        â”‚
â”‚        - LineItemID: item_003 | Bill: â‚¹19.70                        â”‚
â”‚        - LineItemID: item_004 | Bill: â‚¹19.70                        â”‚
â”‚                                                                     â”‚
â”‚  Guarantee: Full line-item breakdown preserved                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STEP 3: STATUS RESOLVER                          â”‚
â”‚                      [ğŸš¦ Traffic Light]                             â”‚
â”‚                                                                     â”‚
â”‚  Resolution Rules (Priority Order):                                 â”‚
â”‚                                                                     â”‚
â”‚    1. Any RED present        â†’ âŒ RED                               â”‚
â”‚    2. Only GREEN + ALLOWED   â†’ âœ… GREEN                             â”‚
â”‚    3. Only MISMATCH          â†’ âš ï¸ MISMATCH                          â”‚
â”‚    4. Admin/Artifact only    â†’ âšª IGNORED                           â”‚
â”‚                                                                     â”‚
â”‚  Example:                                                           â”‚
â”‚    [GREEN, GREEN, GREEN, RED] â†’ Final Status: RED                   â”‚
â”‚    [GREEN, GREEN, ALLOWED]    â†’ Final Status: GREEN                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  STEP 4: CATEGORY RECONCILER                        â”‚
â”‚                      [ğŸ”„ Multi-Category]                            â”‚
â”‚                                                                     â”‚
â”‚  For MISMATCH items:                                                â”‚
â”‚    1. Original category failed                                      â”‚
â”‚    2. Try all other categories                                      â”‚
â”‚    3. Pick best match (highest similarity)                          â”‚
â”‚    4. Update status and add reconciliation note                     â”‚
â”‚                                                                     â”‚
â”‚  Example:                                                           â”‚
â”‚    Item: "CROSS CONSULTATION â€“ IP"                                  â”‚
â”‚    Original: "consultation" â†’ MISMATCH                              â”‚
â”‚    Try: "specialist_consultation" â†’ MATCH (0.78)                    â”‚
â”‚    Result: âœ… GREEN (reconciled)                                    â”‚
â”‚    Note: "Found in alternative category after original failed"      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 STEP 5: FINANCIAL AGGREGATOR                        â”‚
â”‚                       [ğŸ’° Calculator]                               â”‚
â”‚                                                                     â”‚
â”‚  Calculate 3 Levels of Totals:                                      â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Level 1: Line-Item Totals (Phase-1 Preserved)      â”‚           â”‚
â”‚  â”‚   â€¢ Individual item amounts                         â”‚           â”‚
â”‚  â”‚   â€¢ Preserved for traceability                      â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                         â”‚                                           â”‚
â”‚                         â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Level 2: Aggregated Item Totals                    â”‚           â”‚
â”‚  â”‚   â€¢ Group totals                                    â”‚           â”‚
â”‚  â”‚   â€¢ Occurrence counts                               â”‚           â”‚
â”‚  â”‚   â€¢ Per-unit rates                                  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                         â”‚                                           â”‚
â”‚                         â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Level 3: Category Totals                            â”‚           â”‚
â”‚  â”‚   â€¢ Per-category summaries                          â”‚           â”‚
â”‚  â”‚   â€¢ Status counts                                   â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                         â”‚                                           â”‚
â”‚                         â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Level 4: Grand Totals                               â”‚           â”‚
â”‚  â”‚   â€¢ Overall bill amount                             â”‚           â”‚
â”‚  â”‚   â€¢ Overall allowed amount                          â”‚           â”‚
â”‚  â”‚   â€¢ Overall extra amount                            â”‚           â”‚
â”‚  â”‚   â€¢ Overall status counts                           â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        PHASE-2 OUTPUT                               â”‚
â”‚           (Clinically Meaningful Comparison)                        â”‚
â”‚                                                                     â”‚
â”‚  âœ… Aggregated items with breakdown                                 â”‚
â”‚  âœ… Category reconciliation applied                                 â”‚
â”‚  âœ… Multi-level financial summary                                   â”‚
â”‚  âœ… Deep diagnostics for mismatches                                 â”‚
â”‚  âœ… Full traceability to line items                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”¬ Enhanced Hybrid Matching (Phase-2 Upgrade)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HYBRID MATCHING V2                               â”‚
â”‚                                                                     â”‚
â”‚  Input: bill_item, tieup_item                                       â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Component 1: SEMANTIC SIMILARITY (50%)               â”‚         â”‚
â”‚  â”‚  â€¢ Embedding-based matching                           â”‚         â”‚
â”‚  â”‚  â€¢ Captures meaning and context                       â”‚         â”‚
â”‚  â”‚  â€¢ Example: "consultation" â‰ˆ "first visit"            â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                         â”‚                                           â”‚
â”‚                         â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Component 2: TOKEN OVERLAP (25%)                     â”‚         â”‚
â”‚  â”‚  â€¢ Jaccard similarity                                 â”‚         â”‚
â”‚  â”‚  â€¢ Exact term matching                                â”‚         â”‚
â”‚  â”‚  â€¢ Example: {"mri", "brain"} âˆ© {"mri", "brain"}       â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                         â”‚                                           â”‚
â”‚                         â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Component 3: MEDICAL ANCHORS (25%) [NEW!]            â”‚         â”‚
â”‚  â”‚                                                        â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚         â”‚
â”‚  â”‚  â”‚ Dosage Match (+0.4)                      â”‚         â”‚         â”‚
â”‚  â”‚  â”‚ â€¢ "5mg", "10ml", "500mcg"                â”‚         â”‚         â”‚
â”‚  â”‚  â”‚ â€¢ Example: "5mg" in both â†’ +0.4          â”‚         â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚         â”‚
â”‚  â”‚                                                        â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚         â”‚
â”‚  â”‚  â”‚ Modality Match (+0.3)                    â”‚         â”‚         â”‚
â”‚  â”‚  â”‚ â€¢ "MRI", "CT", "X-Ray", "Ultrasound"     â”‚         â”‚         â”‚
â”‚  â”‚  â”‚ â€¢ Example: "MRI" in both â†’ +0.3          â”‚         â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚         â”‚
â”‚  â”‚                                                        â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚         â”‚
â”‚  â”‚  â”‚ Body Part Match (+0.3)                   â”‚         â”‚         â”‚
â”‚  â”‚  â”‚ â€¢ "brain", "chest", "abdomen", "cardiac" â”‚         â”‚         â”‚
â”‚  â”‚  â”‚ â€¢ Example: "brain" in both â†’ +0.3        â”‚         â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                         â”‚                                           â”‚
â”‚                         â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  FINAL SCORE CALCULATION                              â”‚         â”‚
â”‚  â”‚                                                        â”‚         â”‚
â”‚  â”‚  final_score = 0.50 Ã— semantic                        â”‚         â”‚
â”‚  â”‚              + 0.25 Ã— token_overlap                   â”‚         â”‚
â”‚  â”‚              + 0.25 Ã— medical_anchors                 â”‚         â”‚
â”‚  â”‚                                                        â”‚         â”‚
â”‚  â”‚  Threshold: 0.60 (Phase-2)                            â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                         â”‚                                           â”‚
â”‚                         â–¼                                           â”‚
â”‚  Output: (final_score, breakdown_dict)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Category Reconciliation Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  CATEGORY RECONCILIATION                            â”‚
â”‚                                                                     â”‚
â”‚  Item: "CROSS CONSULTATION â€“ IP"                                    â”‚
â”‚  Status: MISMATCH                                                   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Attempt 1: Original Category                         â”‚         â”‚
â”‚  â”‚  Category: "consultation"                             â”‚         â”‚
â”‚  â”‚  Result: MISMATCH (similarity=0.45)                   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                         â”‚                                           â”‚
â”‚                         â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Attempt 2: Alternative Category #1                   â”‚         â”‚
â”‚  â”‚  Category: "specialist_consultation"                  â”‚         â”‚
â”‚  â”‚  Result: MATCH! (similarity=0.78)                     â”‚         â”‚
â”‚  â”‚  Matched: "Specialist Consultation - Inpatient"       â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                         â”‚                                           â”‚
â”‚                         â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Update Item                                          â”‚         â”‚
â”‚  â”‚  â€¢ Status: MISMATCH â†’ GREEN                           â”‚         â”‚
â”‚  â”‚  â€¢ Category: "specialist_consultation"                â”‚         â”‚
â”‚  â”‚  â€¢ Original Category: "consultation"                  â”‚         â”‚
â”‚  â”‚  â€¢ Reconciliation Note: "Found in alternative..."     â”‚         â”‚
â”‚  â”‚  â€¢ Diagnostics: all_categories_tried = [...]          â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                         â”‚                                           â”‚
â”‚                         â–¼                                           â”‚
â”‚  Output: Reconciled Item (GREEN status)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Data Flow Example

### **Input (Phase-1 Output)**

```
Line Items:
  1. NICORANDIL 5MG | Bill: â‚¹19.70 | Allowed: â‚¹49.25 | Status: GREEN
  2. NICORANDIL 5MG | Bill: â‚¹19.70 | Allowed: â‚¹49.25 | Status: GREEN
  3. NICORANDIL 5MG | Bill: â‚¹19.70 | Allowed: â‚¹49.25 | Status: GREEN
  4. NICORANDIL 5MG | Bill: â‚¹19.70 | Allowed: â‚¹49.25 | Status: GREEN
  5. PARACETAMOL 500MG | Bill: â‚¹25.00 | Allowed: â‚¹15.00 | Status: RED
  6. MRI BRAIN | Bill: â‚¹10770.00 | Allowed: â‚¹8500.00 | Status: RED
  7. CONSULTATION | Bill: â‚¹1500.00 | Allowed: â‚¹1500.00 | Status: GREEN
  8. CROSS CONSULTATION | Bill: â‚¹2500.00 | Status: MISMATCH
```

### **Processing**

```
Step 1: Rate Cache
  cache[("nicorandil_5mg", "NICORANDIL 5MG")] = 49.25
  cache[("paracetamol_500mg", "PARACETAMOL 500MG")] = 15.00
  cache[("mri_brain", "MRI Brain")] = 8500.00
  cache[("consultation", "Consultation")] = 1500.00

Step 2: Aggregation
  Group 1: NICORANDIL 5MG (x4) â†’ Total: â‚¹78.80
  Group 2: PARACETAMOL 500MG (x1) â†’ Total: â‚¹25.00
  Group 3: MRI BRAIN (x1) â†’ Total: â‚¹10770.00
  Group 4: CONSULTATION (x1) â†’ Total: â‚¹1500.00
  Group 5: CROSS CONSULTATION (x1) â†’ Total: â‚¹2500.00

Step 3: Status Resolution
  Group 1: [GREEN, GREEN, GREEN, GREEN] â†’ GREEN
  Group 2: [RED] â†’ RED
  Group 3: [RED] â†’ RED
  Group 4: [GREEN] â†’ GREEN
  Group 5: [MISMATCH] â†’ MISMATCH

Step 4: Reconciliation
  Group 5: Try "specialist_consultation" â†’ MATCH! â†’ GREEN

Step 5: Financial Summary
  Category Totals:
    medicines: Bill=â‚¹103.80, Allowed=â‚¹212.00
    diagnostics: Bill=â‚¹12270.00, Allowed=â‚¹10000.00
    specialist_consultation: Bill=â‚¹2500.00, Allowed=â‚¹2500.00
  
  Grand Totals:
    Bill=â‚¹14873.80, Allowed=â‚¹12712.00, Extra=â‚¹2280.00
```

### **Output (Phase-2 Response)**

```json
{
  "aggregated_items": [
    {
      "normalized_name": "nicorandil_5mg",
      "occurrences": 4,
      "total_bill": 78.80,
      "total_allowed": 197.00,
      "status": "GREEN",
      "line_items": [...]
    },
    {
      "normalized_name": "paracetamol_500mg",
      "occurrences": 1,
      "total_bill": 25.00,
      "total_allowed": 15.00,
      "total_extra": 10.00,
      "status": "RED"
    },
    {
      "normalized_name": "cross_consultation_ip",
      "occurrences": 1,
      "total_bill": 2500.00,
      "total_allowed": 2500.00,
      "status": "GREEN",
      "reconciliation_note": "Found in alternative category..."
    }
  ],
  "financial_summary": {
    "grand_totals": {
      "total_bill": 14873.80,
      "total_allowed": 12712.00,
      "total_extra": 2280.00,
      "green_count": 3,
      "red_count": 2,
      "mismatch_count": 0
    }
  }
}
```

---

## ğŸ¯ Key Guarantees

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PHASE-2 GUARANTEES                             â”‚
â”‚                                                                     â”‚
â”‚  âœ… No items disappear between Phase-1 and Phase-2                  â”‚
â”‚     â€¢ All line items preserved in aggregated_items.line_items       â”‚
â”‚                                                                     â”‚
â”‚  âœ… Aggregation is explainable and reversible                        â”‚
â”‚     â€¢ Full breakdown available for every aggregated group           â”‚
â”‚                                                                     â”‚
â”‚  âœ… Debug-friendly: Every number traces back to line items           â”‚
â”‚     â€¢ Line-item â†’ Aggregate â†’ Category â†’ Grand totals              â”‚
â”‚                                                                     â”‚
â”‚  âœ… Audit-ready: Full reconciliation path visible                    â”‚
â”‚     â€¢ original_category, attempted_categories, final_category       â”‚
â”‚                                                                     â”‚
â”‚  âœ… Deep explainability for all mismatches                           â”‚
â”‚     â€¢ Hybrid score breakdown, failure reasons, best candidates      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ File Structure

```
backend/app/verifier/
â”‚
â”œâ”€â”€ models.py                    # Phase-1 models (existing)
â”œâ”€â”€ models_v2.py                 # Phase-2 models (NEW)
â”‚   â”œâ”€â”€ MismatchDiagnosticsV2
â”‚   â”œâ”€â”€ AggregatedItem
â”‚   â”œâ”€â”€ CategoryTotals
â”‚   â”œâ”€â”€ GrandTotals
â”‚   â”œâ”€â”€ FinancialSummary
â”‚   â””â”€â”€ Phase2Response
â”‚
â”œâ”€â”€ aggregator.py                # Aggregation logic (NEW)
â”‚   â”œâ”€â”€ build_rate_cache()
â”‚   â”œâ”€â”€ aggregate_line_items()
â”‚   â””â”€â”€ resolve_aggregate_status()
â”‚
â”œâ”€â”€ reconciler.py                # Category reconciliation (NEW)
â”‚   â”œâ”€â”€ try_alternative_categories()
â”‚   â””â”€â”€ reconcile_categories()
â”‚
â”œâ”€â”€ financial.py                 # Financial aggregation (NEW)
â”‚   â”œâ”€â”€ calculate_category_totals()
â”‚   â”œâ”€â”€ calculate_grand_totals()
â”‚   â””â”€â”€ build_financial_summary()
â”‚
â”œâ”€â”€ phase2_processor.py          # Main orchestrator (NEW)
â”‚   â””â”€â”€ process_phase2()
â”‚
â”œâ”€â”€ medical_anchors.py           # Medical keyword extraction (NEW)
â”‚   â”œâ”€â”€ extract_dosage()
â”‚   â”œâ”€â”€ extract_modality()
â”‚   â”œâ”€â”€ extract_bodypart()
â”‚   â””â”€â”€ calculate_medical_anchor_score()
â”‚
â”œâ”€â”€ artifact_detector.py         # OCR artifact detection (NEW)
â”‚   â””â”€â”€ is_artifact()
â”‚
â””â”€â”€ partial_matcher.py           # Enhanced hybrid matching (UPDATED)
    â”œâ”€â”€ calculate_hybrid_score_v2()
    â””â”€â”€ is_partial_match() [updated]
```

---

## ğŸš€ Ready to Implement!

Use this diagram as a visual reference while implementing Phase-2.

**Next Steps:**
1. Review `PHASE_2_ARCHITECTURE.md` for detailed specifications
2. Follow `PHASE_2_IMPLEMENTATION_PLAN.md` for step-by-step tasks
3. Use `PHASE_2_QUICK_REFERENCE.md` for quick lookups
4. Refer to this diagram for visual understanding
